Tutorial 18: The Power of Momentum ‚Äì Implementing a MACD Strategy
Objective: In this tutorial, you will build a trend-following bot using one of the most popular momentum indicators, the Moving Average Convergence Divergence (MACD). You will learn how to generate buy and sell signals based on crossovers between the MACD line and its signal line.

1. What is the MACD Indicator?
The MACD is a versatile trend-following momentum indicator that shows the relationship between two moving averages of a security‚Äôs price. It consists of three main components:

The MACD Line: The result of subtracting a longer-term Exponential Moving Average (EMA) (typically 26 periods) from a shorter-term EMA (typically 12 periods). This line is fast and reacts quickly to price changes.

The Signal Line: An EMA (typically 9 periods) of the MACD Line itself. This line is slower and smooths out the MACD Line, providing a clearer picture of the trend.

The Histogram: The difference between the MACD Line and the Signal Line. It visually represents the distance between the two lines.

The most common trading signal generated by the MACD is the crossover:

Bullish Crossover (Buy Signal): When the MACD Line crosses above the Signal Line, it suggests that momentum is shifting to the upside.

Bearish Crossover (Sell Signal): When the MACD Line crosses below the Signal Line, it suggests that momentum is shifting to the downside.

2. Prerequisites & Setup
We will continue to use the pandas-ta library, which provides a simple way to calculate the MACD.

Project Setup: In your alpaca_bot_project folder, create a new file named macd_bot.py.

3. Creating the Script (macd_bot.py)
This script will calculate the MACD and its signal line, then enter a trade on a bullish crossover and exit on a bearish crossover.

python
# macd_bot.py

import alpaca_trade_api as tradeapi
import config
import time
import pandas as pd
import pandas_ta as ta
from datetime import datetime

api = tradeapi.REST(config.API_KEY, config.SECRET_KEY, config.BASE_URL, api_version='v2')

# --- Bot Configuration ---
SYMBOL_TO_TRADE = "MSFT"
# Standard MACD parameters
MACD_FAST = 12
MACD_SLOW = 26
MACD_SIGNAL = 9
QTY_PER_TRADE = 10
LOOP_SLEEP_SECONDS = 60 # Check every minute

def run_macd_bot():
    """The main function for the MACD Crossover Bot."""
    print("üöÄ MACD Crossover Bot is starting...")
    
    while True:
        try:
            now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            print(f"\n--- Loop running at {now} ---")

            # --- 1. Check for existing position ---
            try:
                position = api.get_position(SYMBOL_TO_TRADE)
                position_exists = True
                print(f"‚úÖ Position exists: {position.qty} of {SYMBOL_TO_TRADE}.")
            except Exception:
                position_exists = False
                print("‚ÑπÔ∏è No position currently held.")

            # --- 2. Fetch Data ---
            barset = api.get_bars(SYMBOL_TO_TRADE, TimeFrame.Hour, limit=200, adjustment='raw')
            df = barset.df
            
            # --- 3. Calculate MACD using pandas-ta ---
            # This adds MACD, Histogram, and Signal Line columns
            df.ta.macd(fast=MACD_FAST, slow=MACD_SLOW, signal=MACD_SIGNAL, append=True)
            
            # --- 4. Extract latest data points and rename for clarity ---
            df.rename(columns={f'MACD_{MACD_FAST}_{MACD_SLOW}_{MACD_SIGNAL}': 'macd_line',
                               f'MACDs_{MACD_FAST}_{MACD_SLOW}_{MACD_SIGNAL}': 'signal_line'}, inplace=True)
            
            current_bar = df.iloc[-1]
            previous_bar = df.iloc[-2]

            print(f"Price: {current_bar['close']:.2f}, MACD: {current_bar['macd_line']:.2f}, Signal: {current_bar['signal_line']:.2f}")

            # --- 5. Implement MACD Crossover Trading Logic ---
            # BUY Signal (Bullish Crossover)
            if not position_exists and \
               previous_bar['macd_line'] < previous_bar['signal_line'] and \
               current_bar['macd_line'] > current_bar['signal_line']:
                
                print(f"üìà BUY Signal! MACD crossed above Signal Line. Placing order.")
                api.submit_order(symbol=SYMBOL_TO_TRADE, qty=QTY_PER_TRADE, side='buy', type='market', time_in_force='day')

            # SELL Signal (Bearish Crossover)
            elif position_exists and \
                 previous_bar['macd_line'] > previous_bar['signal_line'] and \
                 current_bar['macd_line'] < current_bar['signal_line']:
                
                print(f"üìâ SELL Signal! MACD crossed below Signal Line. Placing order.")
                position_qty = api.get_position(SYMBOL_TO_TRADE).qty
                api.submit_order(symbol=SYMBOL_TO_TRADE, qty=position_qty, side='sell', type='market', time_in_force='day')
            
            else:
                print("Signal: No MACD crossover. Holding.")

            # --- Sleep ---
            time.sleep(LOOP_SLEEP_SECONDS)

        except KeyboardInterrupt:
            print("\nüõë Bot shutting down.")
            break
        except Exception as e:
            print(f"An error occurred: {e}")
            time.sleep(60)

# --- Entry point of the script ---
if __name__ == '__main__':
    run_macd_bot()
4. Understanding the Code
MACD Parameters: We define the standard 12, 26, 9 parameters at the top. pandas-ta will use these to perform the calculations.

df.ta.macd(...): This single command calculates all three components of the MACD. It adds columns to our DataFrame, typically named MACD_12_26_9 (the MACD line), MACDh_12_26_9 (the histogram), and MACDs_12_26_9 (the signal line).

Renaming Columns: To make the code more readable, we rename the default long column names to macd_line and signal_line. This simplifies our if statements significantly.

The Crossover Logic: The logic is identical in principle to the Simple Moving Average crossover bot from earlier tutorials.

Buy Signal: We check if we don't have a position and if on the previous bar the MACD line was below the signal line, AND on the current bar it is above. This detects the precise moment of the bullish cross.

Sell Signal: We check if we do have a position and if the opposite has occurred‚Äîthe MACD line crossing below the signal line. This bearish cross serves as our exit signal.

Trend-Following Nature: The MACD is a trend-following indicator. This bot is designed to catch the beginning of a new trend (up or down) and ride it until the momentum shifts. It is a more responsive alternative to the simple moving average crossover strategy.